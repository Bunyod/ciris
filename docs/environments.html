<html><head><title>Ciris: Multiple Environments</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Viktor Lövgren" /><meta name="description" content="Lightweight, extensible, and validated configuration loading in Scala" /><meta name="og:image" content="/img/poster.png" /><meta name="og:title" content="Ciris: Multiple Environments" /><meta name="og:site_name" content="Ciris" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Lightweight, extensible, and validated configuration loading in Scala" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Ciris: Multiple Environments" /><meta name="twitter:image" content="img/poster.png" /><meta name="twitter:description" content="Lightweight, extensible, and validated configuration loading in Scala" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@vlovgr" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><link rel="stylesheet" href="/css/custom.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Ciris</span></div></a></li> <li><a href="/docs/basics" class="">Usage Basics</a></li> <li><a href="/docs/topics" class="">Configuration Topics</a> <ul class="sub_section"> <li><a href="/docs/validation" class="">Encoding Validation</a></li> <li><a href="/docs/environments" class=" active ">Multiple Environments</a></li> <li><a href="/docs/logging" class="">Logging Configurations</a></li></ul></li> <li><a href="/docs/sources" class="">Configuration Sources</a> <ul class="sub_section"> <li><a href="/docs/supported-sources" class="">Current Supported Sources</a></li> <li><a href="/docs/supporting-new-sources" class="">Supporting New Sources</a></li></ul></li> <li><a href="/docs/decoders" class="">Configuration Decoders</a> <ul class="sub_section"> <li><a href="/docs/supported-types" class="">Current Supported Types</a></li> <li><a href="/docs/supporting-new-types" class="">Supporting New Types</a></li></ul></li> <li><a href="/docs/modules" class="">Modules Overview</a> <ul class="sub_section"> <li><a href="/docs/cats-module" class="">Cats Module</a></li> <li><a href="/docs/cats-effect-module" class="">Cats Effect Module</a></li> <li><a href="/docs/enumeratum-module" class="">Enumeratum Module</a></li> <li><a href="/docs/generic-module" class="">Generic Module</a></li> <li><a href="/docs/refined-module" class="">Refined Module</a></li> <li><a href="/docs/spire-module" class="">Spire Module</a></li> <li><a href="/docs/squants-module" class="">Squants Module</a></li></ul></li> <li><a href="/docs/contributing" class="">Contributing Guide</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/vlovgr/ciris"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/vlovgr/ciris"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="vlovgr" data-github-repo="ciris"><div class="content-wrapper"><section><h1 id="multiple-environments">Multiple Environments</h1>
<p>Being able to have different configuration values in different environments is one of the main reasons why we use configurations. For example, we might want to run our application in a local, testing, and production environment. To be able to work with multiple environments, we first need a representation of them in our application.</p>

<p>One of the most convenient ways to deal with multiple environments with Ciris, is to define them as an <a href="/docs/enumeratum-module">enumeratum</a> enumeration. Since Ciris integrates with enumeratum, we get the ability to load values of that enumeration without having to write any additional code. Alternatively, we could define our own representation of multiple environments, and also define a <a href="/docs/decoders">configuration decoder</a> for that representation.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">object</span> <span class="nc">environments</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">enumeratum._</span>

  <span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">AppEnvironment</span> <span class="k">extends</span> <span class="nc">EnumEntry</span>

  <span class="k">object</span> <span class="nc">AppEnvironment</span> <span class="k">extends</span> <span class="nc">Enum</span><span class="o">[</span><span class="kt">AppEnvironment</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">case</span> <span class="k">object</span> <span class="nc">Local</span> <span class="k">extends</span> <span class="nc">AppEnvironment</span>
    <span class="k">case</span> <span class="k">object</span> <span class="nc">Testing</span> <span class="k">extends</span> <span class="nc">AppEnvironment</span>
    <span class="k">case</span> <span class="k">object</span> <span class="nc">Production</span> <span class="k">extends</span> <span class="nc">AppEnvironment</span>

    <span class="k">val</span> <span class="n">values</span> <span class="k">=</span> <span class="n">findValues</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">import</span> <span class="nn">environments._</span>
<span class="k">import</span> <span class="nn">AppEnvironment._</span>
</code></pre>
</div>

<p>We can now easily load values of that enumeration by just referring to the <code class="highlighter-rouge">AppEnvironment</code> type. Since the environments are represented as <code class="highlighter-rouge">case object</code>s, we can, for example, use pattern matching to use different values for different environments as necessary. Values which are the same across environments can remain as they would have before.</p>

<p>First, let’s define the configuration we want our application to use. We’re using refinement types, together with <a href="/docs/refined-module">refined</a>, to represent our validation logic. For more information, refer to the <a href="/docs/validation">encoding validation</a> section. The <a href="/api/ciris/Secret.html"><code class="highlighter-rouge">Secret</code></a> type is used to denote secret configuration values, to avoid accidentally including the secrets in logs. The <a href="/docs/logging">logging configurations</a> section contains more information.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">ciris.Secret</span>
<span class="k">import</span> <span class="nn">eu.timepit.refined.api.Refined</span>
<span class="k">import</span> <span class="nn">eu.timepit.refined.string.MatchesRegex</span>
<span class="k">import</span> <span class="nn">eu.timepit.refined.types.net.UserPortNumber</span>
<span class="k">import</span> <span class="nn">eu.timepit.refined.types.numeric.PosInt</span>
<span class="k">import</span> <span class="nn">eu.timepit.refined.types.string.NonEmptyString</span>
<span class="k">import</span> <span class="nn">eu.timepit.refined.W</span>

<span class="k">type</span> <span class="kt">ApiKey</span> <span class="o">=</span> <span class="nc">String</span> <span class="nc">Refined</span> <span class="nc">MatchesRegex</span><span class="o">[</span><span class="kt">W.`</span><span class="err">"</span><span class="o">[</span><span class="kt">a-zA-Z0-</span><span class="err">9</span><span class="o">]{</span><span class="err">25</span>,<span class="err">40</span><span class="o">}</span><span class="err">"</span><span class="kt">`.T</span><span class="o">]</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ApiConfig</span><span class="o">(</span>
  <span class="n">key</span><span class="k">:</span> <span class="kt">Secret</span><span class="o">[</span><span class="kt">ApiKey</span><span class="o">],</span>
  <span class="n">port</span><span class="k">:</span> <span class="kt">UserPortNumber</span><span class="o">,</span>
  <span class="n">timeoutSeconds</span><span class="k">:</span> <span class="kt">PosInt</span>
<span class="o">)</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Config</span><span class="o">(</span>
  <span class="n">appName</span><span class="k">:</span> <span class="kt">NonEmptyString</span><span class="o">,</span>
  <span class="n">api</span><span class="k">:</span> <span class="kt">ApiConfig</span>
<span class="o">)</span>
</code></pre>
</div>

<p>As part of the configuration loading, we’re loading the <code class="highlighter-rouge">AppEnvironment</code> we should be running in from the <code class="highlighter-rouge">APP_ENV</code> environment variable. As an example, we’re using different default port numbers depending on the environment – port 4000 in the local and testing environments, and port 9000 in the production environment. Note that the default port is only used if the <code class="highlighter-rouge">http.port</code> system property has not been set.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">ciris.</span><span class="o">{</span><span class="n">env</span><span class="o">,</span> <span class="n">loadConfig</span><span class="o">,</span> <span class="n">prop</span><span class="o">}</span>
<span class="c1">// import ciris.{env, loadConfig, prop}
</span>
<span class="k">import</span> <span class="nn">ciris.enumeratum._</span>
<span class="c1">// import ciris.enumeratum._
</span>
<span class="k">import</span> <span class="nn">ciris.refined._</span>
<span class="c1">// import ciris.refined._
</span>
<span class="k">import</span> <span class="nn">eu.timepit.refined.auto._</span>
<span class="c1">// import eu.timepit.refined.auto._
</span>
<span class="k">val</span> <span class="n">config</span> <span class="k">=</span>
  <span class="n">loadConfig</span><span class="o">(</span>
    <span class="n">env</span><span class="o">[</span><span class="kt">AppEnvironment</span><span class="o">](</span><span class="s">"APP_ENV"</span><span class="o">),</span>
    <span class="n">env</span><span class="o">[</span><span class="kt">Secret</span><span class="o">[</span><span class="kt">ApiKey</span><span class="o">]](</span><span class="s">"API_KEY"</span><span class="o">).</span>
      <span class="n">orElse</span><span class="o">(</span><span class="n">prop</span><span class="o">(</span><span class="s">"api.key"</span><span class="o">)),</span>
    <span class="n">prop</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">UserPortNumber</span><span class="o">]](</span><span class="s">"http.port"</span><span class="o">)</span>
  <span class="o">)</span> <span class="o">{</span> <span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="n">apiKey</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">Config</span><span class="o">(</span>
      <span class="n">appName</span> <span class="k">=</span> <span class="s">"my-api"</span><span class="o">,</span>
      <span class="n">api</span> <span class="k">=</span> <span class="nc">ApiConfig</span><span class="o">(</span>
        <span class="n">key</span> <span class="k">=</span> <span class="n">apiKey</span><span class="o">,</span>
        <span class="n">timeoutSeconds</span> <span class="k">=</span> <span class="mi">10</span><span class="o">,</span>
        <span class="n">port</span> <span class="k">=</span> <span class="n">port</span> <span class="n">getOrElse</span> <span class="o">(</span><span class="n">environment</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Local</span> <span class="o">|</span> <span class="nc">Testing</span> <span class="k">=&gt;</span> <span class="mi">4000</span>
          <span class="k">case</span> <span class="nc">Production</span>      <span class="k">=&gt;</span> <span class="mi">9000</span>
        <span class="o">})</span>
      <span class="o">)</span>
    <span class="o">)</span>
  <span class="o">}</span>
<span class="c1">// config: ciris.ConfigResult[ciris.api.Id,Config] = ConfigResult$1673007852
</span></code></pre>
</div>

<p>Sometimes it might be necessary to have different configuration loading take place in different environments. Ciris provides the <a href="/api/ciris/index.html#withValues[F[_],A1,A2,Z](a1:ciris.ConfigValue[F,A1],a2:ciris.ConfigValue[F,A2])(f:(A1,A2)=&gt;F[Either[ciris.ConfigErrors,Z]])(implicitevidence$6:ciris.api.Monad[F]):F[Either[ciris.ConfigErrors,Z]]"><code class="highlighter-rouge">withValues</code></a> (and <a href="/api/ciris/index.html#withValue[F[_],A1,Z](a1:ciris.ConfigValue[F,A1])(f:A1=&gt;F[Either[ciris.ConfigErrors,Z]])(implicitevidence$3:ciris.api.Monad[F]):F[Either[ciris.ConfigErrors,Z]]"><code class="highlighter-rouge">withValue</code></a> for a single value) function, which allows you to do exactly that. The function takes a number of configuration values, and effectively wraps your <a href="/api/ciris/index.html#loadConfig[F[_],A1,A2,Z](a1:ciris.ConfigValue[F,A1],a2:ciris.ConfigValue[F,A2])(f:(A1,A2)=&gt;Z)(implicitevidence$5:ciris.api.Functor[F]):F[Either[ciris.ConfigErrors,Z]]"><code class="highlighter-rouge">loadConfig</code></a> functions. For example, let’s assume you would want a static configuration in the local and testing environments, while using the configuration loading above in the production environment.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">ciris.withValue</span>
<span class="c1">// import ciris.withValue
</span>
<span class="k">val</span> <span class="n">config</span> <span class="k">=</span>
  <span class="n">withValue</span><span class="o">(</span><span class="n">env</span><span class="o">[</span><span class="kt">AppEnvironment</span><span class="o">](</span><span class="s">"APP_ENV"</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Local</span> <span class="o">|</span> <span class="nc">Testing</span> <span class="k">=&gt;</span>
      <span class="n">loadConfig</span> <span class="o">{</span>
        <span class="nc">Config</span><span class="o">(</span>
          <span class="n">appName</span> <span class="k">=</span> <span class="s">"my-api"</span><span class="o">,</span>
          <span class="n">api</span> <span class="k">=</span> <span class="nc">ApiConfig</span><span class="o">(</span>
            <span class="n">key</span> <span class="k">=</span> <span class="nc">Secret</span><span class="o">(</span><span class="s">"RacrqvWjuu4KVmnTG9b6xyZMTP7jnX"</span><span class="o">),</span>
            <span class="n">timeoutSeconds</span> <span class="k">=</span> <span class="mi">10</span><span class="o">,</span>
            <span class="n">port</span> <span class="k">=</span> <span class="mi">4000</span>
          <span class="o">)</span>
        <span class="o">)</span>
      <span class="o">}</span>

    <span class="k">case</span> <span class="nc">Production</span> <span class="k">=&gt;</span>
      <span class="n">loadConfig</span><span class="o">(</span>
        <span class="n">env</span><span class="o">[</span><span class="kt">Secret</span><span class="o">[</span><span class="kt">ApiKey</span><span class="o">]](</span><span class="s">"API_KEY"</span><span class="o">).</span>
          <span class="n">orElse</span><span class="o">(</span><span class="n">prop</span><span class="o">(</span><span class="s">"api.key"</span><span class="o">)),</span>
        <span class="n">prop</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">UserPortNumber</span><span class="o">]](</span><span class="s">"http.port"</span><span class="o">)</span>
      <span class="o">)</span> <span class="o">{</span> <span class="o">(</span><span class="n">apiKey</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="nc">Config</span><span class="o">(</span>
          <span class="n">appName</span> <span class="k">=</span> <span class="s">"my-api"</span><span class="o">,</span>
          <span class="n">api</span> <span class="k">=</span> <span class="nc">ApiConfig</span><span class="o">(</span>
            <span class="n">key</span> <span class="k">=</span> <span class="n">apiKey</span><span class="o">,</span>
            <span class="n">timeoutSeconds</span> <span class="k">=</span> <span class="mi">10</span><span class="o">,</span>
            <span class="n">port</span> <span class="k">=</span> <span class="n">port</span> <span class="n">getOrElse</span> <span class="mi">4000</span>
          <span class="o">)</span>
        <span class="o">)</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="c1">// config: ciris.ConfigResult[ciris.api.Id,Config] = ConfigResult$1115872972
</span></code></pre>
</div>

<p>Note that when using <a href="/api/ciris/index.html#withValues[F[_],A1,A2,Z](a1:ciris.ConfigValue[F,A1],a2:ciris.ConfigValue[F,A2])(f:(A1,A2)=&gt;F[Either[ciris.ConfigErrors,Z]])(implicitevidence$6:ciris.api.Monad[F]):F[Either[ciris.ConfigErrors,Z]]"><code class="highlighter-rouge">withValues</code></a>, errors for the specified values (in this case, the <code class="highlighter-rouge">APP_ENV</code> environment variable) means we will not continue to try to load the configuration, meaning potential further errors are not included. Assuming we could load an <code class="highlighter-rouge">AppEnvironment</code>, any further errors will be accumulated as you would normally expect.</p>

<p>You might have noticed that there is some duplication of values when loading configurations across the different environments. If we would like to avoid that duplication, we can simply extract the shared parts to a function, like in the following example. Since your configuration models and most values are in code, you can refactor them just like any other code.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">configWithDefaults</span><span class="o">(</span>
  <span class="n">apiKey</span><span class="k">:</span> <span class="kt">Secret</span><span class="o">[</span><span class="kt">ApiKey</span><span class="o">],</span>
  <span class="n">port</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">UserPortNumber</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>
<span class="o">)</span><span class="k">:</span> <span class="kt">Config</span> <span class="o">=</span> <span class="o">{</span>
  <span class="nc">Config</span><span class="o">(</span>
    <span class="n">appName</span> <span class="k">=</span> <span class="s">"my-api"</span><span class="o">,</span>
    <span class="n">api</span> <span class="k">=</span> <span class="nc">ApiConfig</span><span class="o">(</span>
      <span class="n">key</span> <span class="k">=</span> <span class="n">apiKey</span><span class="o">,</span>
      <span class="n">timeoutSeconds</span> <span class="k">=</span> <span class="mi">10</span><span class="o">,</span>
      <span class="n">port</span> <span class="k">=</span> <span class="n">port</span> <span class="n">getOrElse</span> <span class="mi">4000</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">}</span>
<span class="c1">// configWithDefaults: (apiKey: ciris.Secret[ApiKey], port: Option[eu.timepit.refined.types.net.UserPortNumber])Config
</span>
<span class="k">val</span> <span class="n">config</span> <span class="k">=</span>
  <span class="n">withValue</span><span class="o">(</span><span class="n">env</span><span class="o">[</span><span class="kt">AppEnvironment</span><span class="o">](</span><span class="s">"APP_ENV"</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Local</span> <span class="o">|</span> <span class="nc">Testing</span> <span class="k">=&gt;</span>
      <span class="n">loadConfig</span> <span class="o">{</span>
        <span class="n">configWithDefaults</span><span class="o">(</span>
          <span class="n">apiKey</span> <span class="k">=</span> <span class="nc">Secret</span><span class="o">(</span><span class="s">"RacrqvWjuu4KVmnTG9b6xyZMTP7jnX"</span><span class="o">)</span>
        <span class="o">)</span>
      <span class="o">}</span>

    <span class="k">case</span> <span class="nc">Production</span> <span class="k">=&gt;</span>
      <span class="n">loadConfig</span><span class="o">(</span>
        <span class="n">env</span><span class="o">[</span><span class="kt">Secret</span><span class="o">[</span><span class="kt">ApiKey</span><span class="o">]](</span><span class="s">"API_KEY"</span><span class="o">).</span>
          <span class="n">orElse</span><span class="o">(</span><span class="n">prop</span><span class="o">(</span><span class="s">"api.key"</span><span class="o">)),</span>
        <span class="n">prop</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">UserPortNumber</span><span class="o">]](</span><span class="s">"http.port"</span><span class="o">)</span>
      <span class="o">)(</span><span class="n">configWithDefaults</span><span class="o">)</span>
  <span class="o">}</span>
<span class="c1">// config: ciris.ConfigResult[ciris.api.Id,Config] = ConfigResult$1889115145
</span></code></pre>
</div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/js/custom.js"></script><script>((window.gitter = {}).chat = {}).options = {
room: 'vlovgr/ciris'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>